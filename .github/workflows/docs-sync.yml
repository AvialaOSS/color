name: æ–‡æ¡£åŒæ­¥æ£€æŸ¥

on:
  pull_request:
    paths:
      - 'src/**/*.js'
      - 'docs/**/*.md'
  push:
    branches:
      - main
      - bugfix
    paths:
      - 'src/**/*.js'
      - 'docs/**/*.md'

jobs:
  validate-docs:
    name: éªŒè¯æ–‡æ¡£åŒæ­¥
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: éªŒè¯æ–‡æ¡£ä¸ä»£ç åŒæ­¥
        run: npm run docs:validate
      
      - name: æ£€æŸ¥æ–‡æ¡£æ˜¯å¦éœ€è¦æ›´æ–°
        if: failure()
        run: |
          echo "::warning::æ–‡æ¡£éªŒè¯å¤±è´¥ï¼è¯·è¿è¡Œ 'npm run docs:generate' æ›´æ–°æ–‡æ¡£"
          echo "::warning::æˆ–æ£€æŸ¥æºä»£ç ä¸­çš„ JSDoc æ³¨é‡Šæ˜¯å¦å®Œæ•´"

  suggest-update:
    name: æç¤ºæ›´æ–°æ–‡æ¡£
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: æ£€æŸ¥æºä»£ç å˜æ›´
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æºä»£ç 
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^src/.*\.js$'; then
            echo "src_changed=true" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ–‡æ¡£
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^docs/'; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ç”Ÿæˆæ–°æ–‡æ¡£
        if: steps.check-changes.outputs.src_changed == 'true'
        run: npm run docs:generate
      
      - name: æ£€æŸ¥æ–‡æ¡£æ˜¯å¦éœ€è¦æ›´æ–°
        if: steps.check-changes.outputs.src_changed == 'true'
        id: check-doc-diff
        run: |
          if git diff --quiet docs/api-reference.md; then
            echo "éœ€è¦æ›´æ–°æ–‡æ¡£: å¦"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "éœ€è¦æ›´æ–°æ–‡æ¡£: æ˜¯"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
      
      - name: è¯„è®º PR æç¤ºæ›´æ–°æ–‡æ¡£
        if: steps.check-doc-diff.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“š æ–‡æ¡£æ›´æ–°æé†’
              
              æ£€æµ‹åˆ°æ‚¨ä¿®æ”¹äº†æºä»£ç ï¼Œä½† API æ–‡æ¡£å¯èƒ½éœ€è¦æ›´æ–°ã€‚
              
              ### ğŸ”§ å¦‚ä½•æ›´æ–°
              
              è¯·åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤æ›´æ–°æ–‡æ¡£ï¼š
              \`\`\`bash
              npm run docs:generate
              \`\`\`
              
              ç„¶åæäº¤æ›´æ–°åçš„æ–‡æ¡£æ–‡ä»¶ã€‚
              
              ### â„¹ï¸ è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£
              
              ä¸ºäº†ä¿æŒæ–‡æ¡£ä¸ä»£ç åŒæ­¥ï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ä» JSDoc æ³¨é‡Šç”Ÿæˆ API æ–‡æ¡£ã€‚
              è¯·ç¡®ä¿æ‚¨çš„ä»£ç åŒ…å«å®Œæ•´çš„ JSDoc æ³¨é‡Šã€‚`
            })
